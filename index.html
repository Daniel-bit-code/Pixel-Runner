<!DOCTYPE html>
<html>
<head>
    <title>Pixel Runner - Enhanced</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
            border: 2px solid black;
            background: #87CEEB;
        }
        .controls {
            margin-top: 15px;
            padding: 10px 20px;
            background: white;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <canvas id="game" width="800" height="600"></canvas>
    <div class="controls">
        <strong>W/A/S/D</strong> = Move | <strong>SPACE</strong> = Attack | Game Loading...
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        console.log('Game starting...');

        const MAP_WIDTH = 1600;
        const MAP_HEIGHT = 1200;
        
        let cameraX = 0, cameraY = 0, animFrame = 0;
        let player = { 
            x: 100, y: 300, w: 30, h: 35, vx: 0, vy: 0,
            speed: 4, health: 100, maxHealth: 100,
            attackCooldown: 0
        };
        
        let companion = null;
        let monsters = [], coins = [], potions = [], obstacles = [];
        let playerCoins = 0;

        function init() {
            // Create obstacles
            for (let i = 0; i < 20; i++) {
                obstacles.push({
                    x: Math.random() * (MAP_WIDTH - 100),
                    y: Math.random() * (MAP_HEIGHT - 100),
                    w: 80, h: 80
                });
            }
            
            // Create potions
            for (let i = 0; i < 10; i++) {
                let type = i % 2 === 0 ? 'health' : 'speed';
                potions.push({
                    x: Math.random() * (MAP_WIDTH - 30),
                    y: Math.random() * (MAP_HEIGHT - 30),
                    w: 20, h: 30, type
                });
            }
            
            // Create monsters
            for (let i = 0; i < 5; i++) {
                monsters.push({
                    x: 400 + Math.random() * 800,
                    y: 400 + Math.random() * 600,
                    w: 40, h: 45,
                    health: 60, maxHealth: 60,
                    speed: 1.5
                });
            }
            
            // Create companion
            companion = {
                x: player.x - 60, y: player.y,
                w: 35, h: 35,
                health: 80, maxHealth: 80,
                damage: 25, speed: 3.5,
                attackCooldown: 0, targetMonster: null
            };
            
            console.log('Game initialized');
        }

        function toScreen(x, y) {
            return { x: x - cameraX, y: y - cameraY };
        }

        function checkCollision(a, b) {
            return a.x < b.x + b.w && a.x + a.w > b.x && 
                   a.y < b.y + b.h && a.y + a.h > b.y;
        }

        function drawHealthBar(worldX, worldY, width, health, maxHealth) {
            let s = toScreen(worldX, worldY);
            ctx.fillStyle = '#000';
            ctx.fillRect(s.x, s.y - 10, width, 6);
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(s.x, s.y - 10, width, 6);
            ctx.fillStyle = '#00FF00';
            ctx.fillRect(s.x, s.y - 10, (health / maxHealth) * width, 6);
        }

        function drawPlayer() {
            let s = toScreen(player.x, player.y);
            
            drawHealthBar(player.x - 10, player.y - 15, 50, player.health, player.maxHealth);
            
            // Body
            ctx.fillStyle = '#FF4444';
            ctx.fillRect(s.x + 3, s.y + 8, 24, 22);
            ctx.fillStyle = '#CC0000';
            ctx.fillRect(s.x + 12, s.y + 12, 6, 14);
            
            // Head
            ctx.fillStyle = '#FFD4A3';
            ctx.fillRect(s.x + 7, s.y - 2, 16, 12);
            
            // Hair
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(s.x + 7, s.y - 5, 16, 4);
            ctx.fillRect(s.x + 7, s.y - 6, 4, 2);
            ctx.fillRect(s.x + 19, s.y - 6, 4, 2);
            
            // Eyes
            ctx.fillStyle = '#FFF';
            ctx.fillRect(s.x + 10, s.y + 2, 4, 4);
            ctx.fillRect(s.x + 16, s.y + 2, 4, 4);
            ctx.fillStyle = '#000';
            ctx.fillRect(s.x + 11, s.y + 3, 2, 2);
            ctx.fillRect(s.x + 17, s.y + 3, 2, 2);
            
            // Smile
            ctx.fillRect(s.x + 11, s.y + 7, 8, 1);
            
            // Legs
            ctx.fillStyle = '#0066CC';
            ctx.fillRect(s.x + 8, s.y + 30, 6, 10);
            ctx.fillRect(s.x + 16, s.y + 30, 6, 10);
            
            // Shoes
            ctx.fillStyle = '#654321';
            ctx.fillRect(s.x + 6, s.y + 40, 8, 3);
            ctx.fillRect(s.x + 16, s.y + 40, 8, 3);
            
            // Arms
            ctx.fillStyle = '#FFD4A3';
            ctx.fillRect(s.x + 1, s.y + 12, 4, 12);
            ctx.fillRect(s.x + 25, s.y + 12, 4, 12);
            
            // Sword in hand
            ctx.fillStyle = '#C0C0C0';
            ctx.fillRect(s.x + 29, s.y + 10, 4, 20);
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(s.x + 28, s.y + 28, 6, 5);
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(s.x + 31, s.y + 8, 3, 4);
        }

        function drawCompanion() {
            if (!companion) return;
            let s = toScreen(companion.x, companion.y);
            
            drawHealthBar(companion.x, companion.y - 10, companion.w, companion.health, companion.maxHealth);
            
            // Dog companion - detailed
            // Body
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(s.x + 5, s.y + 14, 25, 14);
            
            // Head
            ctx.fillRect(s.x + 5, s.y + 8, 15, 12);
            
            // Ears - floppy
            ctx.fillStyle = '#654321';
            ctx.fillRect(s.x + 4, s.y + 6, 5, 6);
            ctx.fillRect(s.x + 16, s.y + 6, 5, 6);
            
            // Snout
            ctx.fillStyle = '#A0522D';
            ctx.fillRect(s.x + 18, s.y + 14, 6, 5);
            
            // Eyes
            ctx.fillStyle = '#000';
            ctx.fillRect(s.x + 9, s.y + 11, 3, 3);
            ctx.fillRect(s.x + 14, s.y + 11, 3, 3);
            
            // Nose
            ctx.fillRect(s.x + 21, s.y + 16, 2, 2);
            
            // Legs
            ctx.fillStyle = '#654321';
            ctx.fillRect(s.x + 8, s.y + 28, 4, 7);
            ctx.fillRect(s.x + 14, s.y + 28, 4, 7);
            ctx.fillRect(s.x + 20, s.y + 28, 4, 7);
            ctx.fillRect(s.x + 26, s.y + 28, 4, 7);
            
            // Tail - wagging
            let tailWag = Math.sin(animFrame * 0.3) * 3;
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(s.x + 29, s.y + 16 + tailWag, 6, 3);
            
            // Collar
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(s.x + 8, s.y + 18, 10, 2);
        }

        function drawMonster(m) {
            let s = toScreen(m.x, m.y);
            
            drawHealthBar(m.x, m.y - 10, m.w, m.health, m.maxHealth);
            
            // Goblin monster - detailed
            // Body - green
            ctx.fillStyle = '#228B22';
            ctx.fillRect(s.x + 10, s.y + 15, 20, 22);
            
            // Head
            ctx.fillStyle = '#32CD32';
            ctx.fillRect(s.x + 12, s.y + 8, 16, 12);
            
            // Big ears
            ctx.fillStyle = '#228B22';
            ctx.fillRect(s.x + 9, s.y + 10, 4, 6);
            ctx.fillRect(s.x + 27, s.y + 10, 4, 6);
            
            // Eyes - red and evil
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(s.x + 15, s.y + 11, 4, 4);
            ctx.fillRect(s.x + 21, s.y + 11, 4, 4);
            
            // Teeth - sharp
            ctx.fillStyle = '#FFF';
            ctx.fillRect(s.x + 15, s.y + 18, 2, 3);
            ctx.fillRect(s.x + 18, s.y + 18, 2, 3);
            ctx.fillRect(s.x + 21, s.y + 18, 2, 3);
            
            // Arms
            ctx.fillStyle = '#228B22';
            ctx.fillRect(s.x + 7, s.y + 18, 5, 12);
            ctx.fillRect(s.x + 28, s.y + 18, 5, 12);
            
            // Legs
            ctx.fillStyle = '#654321';
            ctx.fillRect(s.x + 13, s.y + 37, 6, 8);
            ctx.fillRect(s.x + 21, s.y + 37, 6, 8);
        }

        function drawPotion(p) {
            let s = toScreen(p.x, p.y);
            
            if (p.type === 'health') {
                // Health potion - red bottle
                ctx.fillStyle = '#8B0000';
                ctx.fillRect(s.x + 5, s.y + 5, 10, 20);
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(s.x + 6, s.y + 6, 8, 18);
                // Shine
                ctx.fillStyle = '#FFF';
                ctx.fillRect(s.x + 8, s.y + 8, 3, 6);
                // Cork
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(s.x + 7, s.y + 2, 6, 4);
                // Plus symbol
                ctx.fillStyle = '#FFF';
                ctx.fillRect(s.x + 9, s.y + 13, 2, 6);
                ctx.fillRect(s.x + 7, s.y + 15, 6, 2);
            } else {
                // Speed potion - cyan bottle
                ctx.fillStyle = '#008B8B';
                ctx.fillRect(s.x + 5, s.y + 5, 10, 20);
                ctx.fillStyle = '#00FFFF';
                ctx.fillRect(s.x + 6, s.y + 6, 8, 18);
                // Shine
                ctx.fillStyle = '#FFF';
                ctx.fillRect(s.x + 8, s.y + 8, 3, 6);
                // Cork
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(s.x + 7, s.y + 2, 6, 4);
                // Lightning bolt
                ctx.fillStyle = '#FFFF00';
                ctx.fillRect(s.x + 9, s.y + 12, 2, 4);
                ctx.fillRect(s.x + 8, s.y + 14, 2, 2);
                ctx.fillRect(s.x + 10, s.y + 16, 2, 4);
            }
        }

        function drawCoin(c) {
            let s = toScreen(c.x, c.y);
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(s.x + 2, s.y, 12, 16);
            ctx.fillStyle = '#FFA500';
            ctx.fillRect(s.x + 4, s.y + 2, 8, 12);
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(s.x + 6, s.y + 4, 4, 8);
        }

        function drawObstacle(o) {
            let s = toScreen(o.x, o.y);
            ctx.fillStyle = '#8B7355';
            ctx.fillRect(s.x, s.y, o.w, o.h);
            ctx.fillStyle = '#A0826D';
            ctx.fillRect(s.x + 5, s.y + 5, o.w - 10, o.h - 10);
            ctx.fillStyle = '#6B5645';
            ctx.fillRect(s.x + 10, s.y + 10, o.w - 20, o.h - 20);
        }

        function updateCompanion() {
            if (!companion) return;
            
            // Find nearest monster
            let nearest = null;
            let nearestDist = Infinity;
            
            for (let m of monsters) {
                let dx = m.x - companion.x;
                let dy = m.y - companion.y;
                let dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < nearestDist) {
                    nearestDist = dist;
                    nearest = m;
                }
            }
            
            companion.targetMonster = nearest;
            
            if (nearest && nearestDist < 300) {
                // Chase the monster
                let dx = nearest.x - companion.x;
                let dy = nearest.y - companion.y;
                let dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 50) {
                    companion.x += (dx / dist) * companion.speed;
                    companion.y += (dy / dist) * companion.speed;
                }
                
                // Attack if close enough
                if (dist < 50 && companion.attackCooldown === 0) {
                    nearest.health -= companion.damage;
                    companion.attackCooldown = 40;
                }
            } else {
                // Follow player
                let dx = player.x - 60 - companion.x;
                let dy = player.y - companion.y;
                let dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 80) {
                    companion.x += (dx / dist) * companion.speed;
                    companion.y += (dy / dist) * companion.speed;
                }
            }
            
            if (companion.attackCooldown > 0) companion.attackCooldown--;
        }

        function update() {
            animFrame++;
            
            // Camera
            cameraX = player.x - 400;
            cameraY = player.y - 300;
            cameraX = Math.max(0, Math.min(cameraX, MAP_WIDTH - 800));
            cameraY = Math.max(0, Math.min(cameraY, MAP_HEIGHT - 600));

            // Clear
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, 800, 600);

            // Ground
            ctx.fillStyle = '#90EE90';
            ctx.fillRect(0, 550, 800, 50);

            // Update player
            player.x += player.vx;
            player.y += player.vy;
            player.x = Math.max(0, Math.min(player.x, MAP_WIDTH - player.w));
            player.y = Math.max(0, Math.min(player.y, MAP_HEIGHT - player.h));

            if (player.attackCooldown > 0) player.attackCooldown--;

            // Obstacles
            for (let o of obstacles) {
                if (checkCollision(player, o)) {
                    player.x -= player.vx;
                    player.y -= player.vy;
                }
                drawObstacle(o);
            }

            // Potions
            for (let i = potions.length - 1; i >= 0; i--) {
                let p = potions[i];
                drawPotion(p);
                
                if (checkCollision(player, p)) {
                    if (p.type === 'health') {
                        player.health = Math.min(player.maxHealth, player.health + 30);
                    }
                    potions.splice(i, 1);
                }
            }

            // Coins
            for (let i = coins.length - 1; i >= 0; i--) {
                let c = coins[i];
                drawCoin(c);
                
                if (checkCollision(player, c)) {
                    playerCoins += 10;
                    coins.splice(i, 1);
                }
            }

            // Monsters
            for (let i = monsters.length - 1; i >= 0; i--) {
                let m = monsters[i];
                
                // Move toward player
                if (m.x > player.x) m.x -= m.speed;
                else m.x += m.speed;
                if (m.y > player.y) m.y -= m.speed;
                else m.y += m.speed;
                
                drawMonster(m);
                
                if (m.health <= 0) {
                    coins.push({ x: m.x, y: m.y, w: 16, h: 16 });
                    playerCoins += 5;
                    monsters.splice(i, 1);
                } else if (checkCollision(player, m)) {
                    player.health -= 0.1;
                }
            }

            // Companion AI
            updateCompanion();
            drawCompanion();

            // Draw player
            drawPlayer();

            if (player.health <= 0) {
                alert('Game Over! Coins: ' + playerCoins);
                location.reload();
            }

            // UI
            ctx.fillStyle = '#000';
            ctx.font = 'bold 20px Arial';
            ctx.fillText(`HP: ${Math.floor(player.health)}/${player.maxHealth}`, 10, 30);
            ctx.fillText(`Coins: ${playerCoins} ðŸ’°`, 10, 55);
            ctx.fillText(`Companion HP: ${companion ? Math.floor(companion.health) : 0}`, 10, 80);

            if (Math.random() < 0.01) {
                monsters.push({
                    x: Math.random() * MAP_WIDTH,
                    y: Math.random() * MAP_HEIGHT,
                    w: 40, h: 45,
                    health: 60, maxHealth: 60,
                    speed: 1.5
                });
            }

            requestAnimationFrame(update);
        }

        let keys = {};
        document.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (e.code === 'KeyW') player.vy = -player.speed;
            if (e.code === 'KeyS') player.vy = player.speed;
            if (e.code === 'KeyA') player.vx = -player.speed;
            if (e.code === 'KeyD') player.vx = player.speed;
            if (e.code === 'Space') {
                e.preventDefault();
                if (player.attackCooldown === 0) {
                    for (let m of monsters) {
                        if (Math.abs(m.x - player.x) < 60 && Math.abs(m.y - player.y) < 50) {
                            m.health -= 30;
                        }
                    }
                    player.attackCooldown = 30;
                }
            }
        });

        document.addEventListener('keyup', e => {
            keys[e.code] = false;
            if (e.code === 'KeyW' || e.code === 'KeyS') player.vy = 0;
            if (e.code === 'KeyA' || e.code === 'KeyD') player.vx = 0;
        });

        init();
        update();
        console.log('Game running!');
    </script>
</body>
</html>